#!/usr/bin/env node

var parseArgs = require('minimist');
var argv = parseArgs(process.argv.slice(2));
var nb = require('../')(argv);
var debug = require('debug')('benchmark:nb');
var log = console.log;

nb.on('all connected', handleAllConnected);
nb.on('exit', handleExit);

// hook `Ctrl + C`
process.on('SIGINT', handleQuit);

// start benchmarkding
nb.run();


// internal handle funcs

function handleAllConnected(nClients){
  debug('all clients: '+ nClients +' connected, ready to emit!');
  
  log(['\n\n', //seperate lines
       '########################################',
       '####                                ####',
       '####   socket.io benchmark tool     ####',
       '####                                ####',
       '####            v 0.0.1             ####',
       '####                                ####',
       '########################################',
       'e.g.:Please Enter msg to broadcasting...',
       '> hi all',
       '',
       '########################################',
       ''
       ].join('\n'));

  // repl util for mastering benchmark tool
  process.stdin.setEncoding('utf8');
  process.stdin.on('readable', function(){
    var chunk = process.stdin.read();
    if (chunk !== null) {

      // var args = [];
      // try{
      //   args = parseArgs(chunk.split(' '));        
      // } catch(err){
      //   process.stdout.write('format error : ' + err + '\n');
      // }

      // if(!args.n) return process.stdout.write('Just support -n param >.<!');
      nb.broadcast(chunk);
    }
  });

  process.stdin.on('end', function(){
    process.stdout.write('end');
  });
}

function handleExit(){
  debug('Quit node benchmark process!');
  process.exit(0);
}

function handleQuit() {
  debug("Stoping workers elegantly...");

  nb.stop();
}